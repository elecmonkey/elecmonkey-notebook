# 第2章 应用层

## 2.1 应用层与网络应用开发原则
### 2.1.1 应用层的角色与位置
应用层（application layer）直接面向用户与应用，是我们“看得见”的网络：浏览网页、发邮件、看视频、打游戏等都属于应用层范围。它运行在端系统（end systems）中，网络核心只负责转发分组，不需要理解具体应用内容。这种设计使得应用可以快速演化，而不会破坏互联网整体结构。

### 2.1.2 网络体系结构 vs 应用体系结构
- 网络体系结构（network architecture）：如 TCP/IP 五层模型或 OSI 模型，固定、统一，决定了网络“提供什么样的服务”。
- 应用体系结构（application architecture）：由应用开发者决定，描述应用如何分布在多个端系统上。

举例：HTTP 是应用层协议，但 HTTP 使用 TCP 还是 UDP 由开发者决定；使用 C/S 还是 P2P 由应用体系结构决定。

### 2.1.3 开发网络应用的基本原则
- 把复杂性放在边缘（edge）：核心网只做转发，端系统负责应用逻辑。
- 复用成熟协议：尽量使用 TCP/UDP，不重复实现底层功能。
- 需求驱动：是否可靠、是否实时、是否安全，决定协议选择与设计。

## 2.2 应用体系结构：C/S 与 P2P
### 2.2.1 客户端/服务器（Client/Server, C/S）
特点：
- 服务器（server）常在线、有固定 IP，通常部署在数据中心。
- 客户端（client）发起连接，IP 可变且可能间歇在线。
- 客户端之间一般不直接通信。

优点：
- 集中管理，安全与维护成本可控。
- 易于扩展：可通过多台服务器或负载均衡扩容。

缺点：
- 服务器压力大，成本高。
- 单点故障风险（可通过冗余缓解）。

典型应用：Web（HTTP）、FTP、电子邮件访问（IMAP）。

### 2.2.2 对等体（Peer-to-Peer, P2P）
特点：
- 没有长期在线的中心服务器。
- 终端之间直接通信。
- 新节点既提供服务能力也提出需求，具有自扩展性（self-scalability）。

优点：
- 节省中心服务器成本。
- 理论上更易扩展。

缺点：
- 节点不稳定（随时上线/下线）。
- 管理复杂，安全与内容治理困难。

典型应用：P2P 文件共享，部分实时通信。

### 2.2.3 混合架构（补充）
很多应用实际采用混合模式：
- 登录、目录、认证由服务器管理。
- 数据传输可能 P2P（如部分视频会议、文件分发）。

## 2.3 进程通信、套接字与寻址
### 2.3.1 进程间通信
进程（process）是运行在主机上的程序。不同主机上的进程通过网络交换消息。角色划分：
- 客户端进程：主动发起通信。
- 服务器进程：等待请求并响应。

### 2.3.2 套接字（socket）
套接字是应用与传输层之间的接口，类似“门”。应用对传输层的控制有限，主要能决定：
- 选用 TCP 还是 UDP。
- 设置缓冲区大小或最大段大小（MSS）。

### 2.3.3 进程寻址方式
要定位一个进程，需要：
- IP 地址（IP address）：定位主机。
- 端口号（port number）：定位主机内具体进程。

示例：HTTP 默认端口 80，HTTPS 默认端口 443。

## 2.4 应用层协议与传输层服务需求
### 2.4.1 应用层协议定义
应用层协议规定：
- 报文类型（request/response）
- 报文格式（字段与分隔方式）
- 报文语义（字段含义）
- 交互规则（时序与响应方式）

### 2.4.2 开放协议与专有协议
- 开放协议（open protocol）：RFC 标准，任何人可实现，如 HTTP、SMTP。
- 专有协议（proprietary）：由厂商控制，如 Skype、Zoom。

开放协议带来互操作性，专有协议可能带来更快迭代与功能差异化。

### 2.4.3 应用对传输层的服务需求
不同应用对传输服务的需求不同：
- 数据可靠性（reliability）：文件传输、Web 交易需要 100% 正确。
- 吞吐量（throughput）：视频/音频需要一定最低速率。
- 时延（delay）：实时语音、在线游戏要求低时延。
- 安全（security）：加密、认证、完整性。

### 2.4.4 TCP 与 UDP 对比
TCP（Transmission Control Protocol）：
- 可靠、按序交付
- 流量控制（flow control）
- 拥塞控制（congestion control）
- 面向连接（connection-oriented）

UDP（User Datagram Protocol）：
- 无连接
- 不保证可靠性
- 无拥塞控制
- 头部小、延迟低

选择建议：
- 可靠性优先 → TCP
- 实时性优先 → UDP（应用层可自行容错）

### 2.4.5 TLS 安全
TLS（Transport Layer Security）位于应用层与传输层之间，提供：
- 加密（confidentiality）
- 完整性（integrity）
- 端点认证（authentication）

TLS 常基于 TCP（如 HTTPS），使得“明文”数据在传输中被加密。

## 2.5 Web 与 HTTP
### 2.5.1 Web 对象与 URL
一个网页由多个对象组成：HTML 文件、图片、音频、脚本等。每个对象由 URL 标识：
`protocol://host:port/path`
HTTP 默认端口 80。

### 2.5.2 HTTP 基本特性
HTTP（HyperText Transfer Protocol）是 Web 的应用层协议：
- 基于 TCP
- 客户端请求、服务器响应
- 无状态（stateless）：服务器不保存历史请求信息

无状态使服务器更简单，但需要其他机制（如 cookies）保持会话状态。

### 2.5.3 非持久 HTTP（non-persistent）
每个对象建立一个 TCP 连接：
- 1 RTT 用于三次握手
- 1 RTT 用于请求与响应首部
- 再加上对象传输时间

因此单个对象约耗时 2 RTT + 传输时间。多个对象会导致显著延迟。

### 2.5.4 持久 HTTP（persistent）
HTTP/1.0+ 与 HTTP/1.1 支持持久连接：
- 一个 TCP 连接传输多个对象
- 可流水线（pipeline）发送多个请求
- 浏览器可并行开启多个 TCP 连接以加速

### 2.5.5 HTTP 报文结构
请求报文：请求行（方法、URL、版本）+ 首部 + 空行 + 实体主体（可选）。
响应报文：状态行（版本、状态码、原因短语）+ 首部 + 空行 + 实体主体。

### 2.5.6 HTTP 方法
- GET：请求资源，参数在 URL 中
- POST：提交数据，放在请求体中
- HEAD：仅获取首部
- PUT：上传并替换资源

### 2.5.7 状态码
常见状态码：
- 200 OK
- 301 Moved Permanently
- 400 Bad Request
- 404 Not Found
- 500 Internal Server Error

### 2.5.8 Cookies 与会话
Cookies 用于解决 HTTP 无状态的问题：
- 服务器在响应中设置 cookie
- 浏览器存储并在后续请求携带

用途：登录保持、购物车、个性化推荐。
风险：隐私泄露与跨站追踪。

### 2.5.9 Web 缓存（proxy）
缓存服务器位于客户端与源站之间：
- 命中直接返回
- 未命中向源站请求并缓存

优势：降低时延、减少链路负载。

### 2.5.10 条件 GET
客户端携带 If-Modified-Since：
- 若资源未更新，服务器返回 304 Not Modified
- 若已更新，返回 200 OK 并带新对象

### 2.5.11 HTTP/2 与 HTTP/3
HTTP/2：
- 报文分帧并交错传输
- 缓解队头阻塞（HOL blocking）

HTTP/3：
- 基于 UDP
- 更好的丢包恢复与安全支持

## 2.6 电子邮件系统
### 2.6.1 三大组件
- 用户代理（user agent）
- 邮件服务器（mail server）
- 邮件协议：SMTP、POP3、IMAP

### 2.6.2 SMTP（发送协议）
SMTP（Simple Mail Transfer Protocol）：
- TCP 端口 25
- push 模式发送
- 典型阶段：握手、传输、关闭

SMTP 采用 ASCII 命令/响应，类似 HTTP。

### 2.6.3 SMTP 与 HTTP 对比
- HTTP 为拉取（pull），SMTP 为推送（push）
- SMTP 允许一条连接发送多个对象
- SMTP 要求 7-bit ASCII

### 2.6.4 POP3（接收协议）
POP3（Post Office Protocol v3）：
- 端口 110
- 三阶段：授权、事务、更新
- 典型模式：下载后删除或保留

### 2.6.5 IMAP（接收协议）
IMAP（Internet Message Access Protocol）：
- 端口 143
- 邮件保存在服务器
- 支持文件夹、搜索、多端同步

### 2.6.6 Webmail
Webmail 使用浏览器访问：
- 发送：SMTP
- 接收：IMAP/POP3

## 2.7 域名系统 DNS
### 2.7.1 DNS 的作用
DNS（Domain Name System）负责：
- 域名 ↔ IP 地址转换
- 主机别名（alias）
- 邮件服务器别名
- 负载均衡（一个域名映射多个 IP）

### 2.7.2 分布式层次结构
DNS 是层次化分布式数据库：
- 根服务器（root）
- 顶级域名服务器（TLD，如 .com、.cn）
- 权威服务器（authoritative）

### 2.7.3 本地 DNS 与缓存
本地 DNS 通常由 ISP 提供：
- 缓存提高查询速度
- TTL 过期后重新解析

### 2.7.4 迭代与递归查询
- 迭代查询：服务器返回“下一跳”信息
- 递归查询：服务器代替客户端完成解析

### 2.7.5 资源记录（RR）
格式：（name, value, type, ttl）
- A：主机名 → IPv4
- NS：域 → 权威服务器
- CNAME：别名 → 规范名
- MX：邮件服务器

### 2.7.6 DNS 报文结构
包括：标识、标志、问题数、回答数、权威记录数、附加记录数。

### 2.7.7 主机端解析流程
浏览器缓存 → 系统缓存 → hosts 文件 → 本地 DNS → 权威 DNS。
