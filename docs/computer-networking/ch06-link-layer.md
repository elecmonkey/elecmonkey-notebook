# 第6章 链路层与局域网

## 6.1 链路层概念与服务
### 6.1.1 基本术语
- 节点（node）：主机或路由器。
- 链路（link）：连接相邻节点的通信信道。
- 帧（frame）：链路层数据单元，封装网络层数据报（datagram）。

### 6.1.2 链路层的主要服务
- 成帧（framing）：把数据报封装成帧，添加首部与尾部。
- 介质访问控制（MAC, Medium Access Control）：共享链路上谁先发送。
- 可靠交付（reliable delivery）：对高误码链路有价值。
- 流量控制（flow control）：相邻节点速率匹配。
- 差错检测/纠正。
- 半双工（half-duplex）与全双工（full-duplex）。

### 6.1.3 链路层实现位置
链路层通常由网卡（NIC）或芯片实现，属于硬件、固件与驱动的组合。

## 6.2 差错检测与纠正
### 6.2.1 奇偶校验（parity）
- 单比特奇偶校验：检测单比特错误。
- 二维奇偶校验：可定位并纠正单比特错误。

### 6.2.2 Internet 校验和
对 16 位字进行 1’s complement 求和，常用于 UDP。能检测错误，但可能漏检。

### 6.2.3 CRC（循环冗余检测）
CRC（Cyclic Redundancy Check）通过生成多项式进行校验：
- 发送端添加冗余位
- 接收端进行模 2 除法验证
CRC 可检测突发错误，广泛用于以太网与 WiFi。

## 6.3 多路访问协议
### 6.3.1 链路类型
- 点对点（point-to-point）：如拨号、光纤直连
- 广播（broadcast）：多个节点共享同一介质

### 6.3.2 随机接入协议
典型协议：
- 纯 ALOHA、时隙 ALOHA
- CSMA（载波侦听多路访问）
- CSMA/CD（碰撞检测）
- CSMA/CA（碰撞避免）

### 6.3.3 CSMA/CD 核心思想
- 先监听信道
- 发生碰撞立即停止发送
- 二进制指数退避（binary exponential backoff）
以太网规定最小帧长确保碰撞可检测。

## 6.4 以太网与交换机
### 6.4.1 以太网特性
以太网（Ethernet）是最常见的有线 LAN 技术：
- 无连接、尽力而为
- 早期共享介质采用 CSMA/CD
- 现代交换式以太网全双工，无碰撞

### 6.4.2 以太网帧结构
字段包含前同步码、帧开始定界符、目的/源 MAC、类型、数据、CRC。

### 6.4.3 交换机工作原理
- 存储转发（store-and-forward）
- 学习源 MAC 建立转发表（self-learning）
- 根据目的 MAC 转发或过滤

### 6.4.4 交换机与路由器对比
- 交换机：链路层设备，基于 MAC 地址转发。
- 路由器：网络层设备，基于 IP 地址转发。
交换机易产生广播风暴，路由器可隔离广播域。

## 6.5 MAC 地址与 ARP
### 6.5.1 MAC 地址
MAC 地址（LAN address）为 48 位物理地址，标识网络接口。

### 6.5.2 ARP 协议
ARP（Address Resolution Protocol）将 IP 映射为 MAC：
- 查询使用广播
- 响应使用单播

### 6.5.3 ARP 表
ARP 表保存（IP，MAC，TTL）映射，缓存提高效率。

### 6.5.4 跨网段转发
若目的地址不在本子网，帧目的 MAC 为默认网关接口 MAC，由路由器转发。

## 6.6 VLAN 与 802.1Q
### 6.6.1 VLAN 动机
- 缩小广播域
- 逻辑隔离不同部门
- 支持用户迁移

### 6.6.2 VLAN 类型
- 端口 VLAN：按端口划分
- 动态 VLAN：按 MAC 动态分配

### 6.6.3 VLAN 间通信
不同 VLAN 之间通信需要路由器或三层交换机。

### 6.6.4 802.1Q
802.1Q 帧中插入 VLAN Tag：
- 12 位 VLAN ID
- 优先级字段
用于 trunk 端口在多交换机间转发。

## 6.7 Web 请求的链路层流程
### 6.7.1 DHCP 获取地址
DHCP 报文通过 UDP/IP/以太网封装并广播。

### 6.7.2 DNS 查询与 ARP
DNS 查询经 UDP/IP 封装，需要先用 ARP 获取默认网关 MAC。

### 6.7.3 逐层封装与转发
应用数据 → 传输层段 → IP 数据报 → 以太网帧，经交换机送到路由器。
