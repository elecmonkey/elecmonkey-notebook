# 第4章 网络层：数据平面

## 4.1 网络层服务与数据平面/控制平面
### 4.1.1 网络层的职责
网络层（network layer）负责把传输层报文段封装成数据报（datagram），并在路由器之间转发，使数据从源主机到达目的主机。它在所有互联网设备中实现：主机与路由器都需要网络层协议。

### 4.1.2 两大功能：转发与路由
- 转发（forwarding）：路由器本地动作，根据转发表把数据报从输入端口送到正确输出端口。
- 路由（routing）：全局动作，计算从源到目的的路径。

### 4.1.3 数据平面与控制平面
- 数据平面（data plane）：逐路由器的本地转发逻辑，强调“快”。
- 控制平面（control plane）：网络范围内的路由逻辑，决定转发表，强调“全局”。

### 4.1.4 控制平面两种实现方式
- 传统路由：路由算法分布在每台路由器中。
- SDN（Software-Defined Networking）：由集中控制器计算转发表并下发。

## 4.2 服务模型与虚电路/数据报
### 4.2.1 网络服务模型
理论上网络层可提供：
- 有序交付
- 可靠交付
- 最小带宽
- 最大时延限制

互联网采用尽力而为（best-effort）：
- 不保证可靠性
- 不保证时延与带宽
- 不保证顺序

### 4.2.2 虚电路网络（Virtual Circuit）
虚电路网络类似电路交换：
- 先建立连接
- 同一路径传输
- 分组使用短虚电路号
- 适合稳定流量

### 4.2.3 数据报网络（Datagram）
数据报网络（如 IP）特点：
- 无连接建立
- 每个分组独立路由
- 可能乱序到达
可靠性由端系统（如 TCP）保证。

### 4.2.4 虚电路与数据报比较
- 虚电路：路径固定，顺序保证，结点故障影响连接。
- 数据报：路径可能变化，顺序不保证，健壮性更强。

## 4.3 路由器体系结构
### 4.3.1 路由器组成
- 路由处理器（routing processor）：运行路由协议、维护转发表。
- 输入端口（input ports）：收分组、查表转发。
- 输出端口（output ports）：排队与发送。
- 交换结构（switch fabric）：连接输入与输出。

### 4.3.2 输入端口处理流程
1) 物理层接收比特流
2) 链路层解封装
3) 查找转发表
4) 进入输入队列等待交换

### 4.3.3 输出端口处理流程
1) 缓冲分组
2) 链路层封装
3) 物理层发送

## 4.4 转发与最长前缀匹配
### 4.4.1 基于目的地址转发
传统转发依据目的 IP 地址选择输出端口。

### 4.4.2 最长前缀匹配（Longest Prefix Matching）
当多个前缀匹配目的地址时，选择最长前缀：
- 更具体的前缀优先
- 保证路由的精确性

### 4.4.3 泛化转发
除目的地址外，可匹配更多首部字段（如端口、协议号），支持更灵活的转发策略。

## 4.5 交换结构与排队现象
### 4.5.1 交换结构类型
- 基于内存（memory）：受内存带宽限制。
- 基于总线（bus）：一次只能转发一个分组。
- 基于互连网络（interconnection）：并行转发能力最强。

### 4.5.2 输入排队与丢包
若输入速率超过交换能力，输入端口缓冲区排队，可能溢出导致丢包。

### 4.5.3 队首阻塞（HOL blocking）
队首分组阻塞后续分组，即使后续分组要去不同输出端口。

## 4.6 SDN 数据平面视角
### 4.6.1 传统路由平面
分布式控制平面：各路由器运行路由算法并同步拓扑信息。

### 4.6.2 SDN 的核心思想
控制平面与数据平面分离：
- 控制器集中计算
- 路由器仅执行转发

### 4.6.3 SDN 的意义
- 统一管理、简化策略配置
- 更灵活的转发控制
