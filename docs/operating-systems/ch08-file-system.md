# 第八章 文件系统

## 8.1 文件系统概述

**文件系统 (File System)** 是操作系统中负责管理和存储文件的组件，它为用户和应用程序提供了一个统一的逻辑视图来访问存储在辅助存储设备上的数据。文件系统抽象了物理存储设备的复杂性，将数据组织成文件和目录的层次结构。

### 8.1.1 文件系统的作用

文件系统主要解决两个核心问题：

1. **用户界面设计**：定义文件和其属性、操作以及目录结构应该如何呈现给用户
2. **物理实现**：创建算法和数据结构将逻辑文件系统映射到物理存储设备上

主内存通常太小，无法永久容纳所有数据和程序，因此计算机系统使用辅助存储作为主内存的备份。辅助存储设备包括磁盘、磁带、光盘、软盘、闪存等，它们在访问时间、容量、数据传输速率和数据传输方法等方面各不相同。

### 8.1.2 文件系统的层次结构

文件系统被组织成多个层次，从上到下包括：

1. **应用程序 (Application Programs)**
2. **逻辑文件系统 (Logical File System)**
3. **文件组织模块 (File-Organization Module)**
4. **基本文件系统 (Basic File System)**
5. **I/O控制 (I/O Control)**
6. **设备 (Devices)**

#### 逻辑文件系统层
- 管理元数据信息（除实际数据外的所有文件系统结构）
- 管理目录结构
- 通过文件控制块(FCB)管理文件结构
- 负责保护和安全

#### 文件组织模块层
- 了解文件及其逻辑块，以及物理块
- 将文件的逻辑块地址转换为物理块地址
- 管理空闲空间：跟踪未分配的块，并在请求时提供这些块

#### 基本文件系统层
- 向适当的设备驱动程序发出通用命令，在磁盘上读写物理块
- 输入：检索块123
- 输出：检索驱动器1，柱面73，磁头2，扇区10

#### I/O控制层
- 由设备驱动程序和中断处理程序组成，用于在主内存和磁盘系统之间传输信息
- 设备驱动程序可以看作是翻译器，将高级命令转换为硬件控制器使用的低级硬件特定指令

## 8.2 文件概念与接口

### 8.2.1 文件的定义

**文件 (File)** 是记录在辅助存储上的相关信息的命名集合。通常，文件表示程序（源代码和目标形式）和数据。程序或数据除非在文件中，否则无法写入辅助存储。

### 8.2.2 文件属性

文件具有以下基本属性：

- **名称 (Name)**：符号文件名，以人类可读的形式
- **标识符 (Identifier)**：在文件系统内标识文件的唯一标签（通常是数字）
- **类型 (Type)**：支持不同类型的系统需要此信息
- **位置 (Location)**：指向设备上文件位置的指针
- **大小 (Size)**：当前文件大小
- **保护 (Protection)**：控制谁可以进行读、写、执行操作
- **时间、日期和用户标识**：用于保护、安全和使用监控的数据

有关文件的信息保存在目录结构中，该结构维护在磁盘上。

### 8.2.3 文件类型

#### 按内容分类
- **数据文件**：数字、字母、字母数字、二进制
- **程序文件**：源程序、目标形式、可执行程序

#### 按形式分类
- **自由形式**：如文本文件，含义由文件的创建者和用户定义
- **格式化严格**：如数据库文件

### 8.2.4 文件操作

#### 六个基本操作
1. **创建 (Create)**：分配文件空间并分配目录条目
2. **读取 (Read)**：从文件中读取数据
3. **写入 (Write)**：向文件中写入数据
4. **重定位/查找 (Seek)**：在文件内搜索特定位置
5. **删除 (Delete)**：查找目录条目并释放所有文件空间，擦除目录条目
6. **截断 (Truncate)**：擦除文件内容但保留其属性（长度除外，设为0，释放文件空间）

#### 其他常见操作
- **追加 (Appending)**：在文件末尾添加数据
- **重命名 (Renaming)**：更改文件名
- **获取/设置文件属性**：读取或修改文件的元数据

### 8.2.5 打开文件操作

#### Open操作
```c
int fd = open(filename, mode);
```

- 在磁盘上搜索目录结构以查找条目F
- 将目录条目复制到打开文件表中
- 分配文件描述符
- 返回文件描述符给调用者

大多数文件操作都涉及搜索与命名文件关联的目录条目。为避免常量搜索，系统调用`open()`在其他操作之前使用。

#### Close操作
```c
close(fd);
```

- 将打开文件表中的目录条目复制到磁盘上的目录结构
- 释放文件描述符
- 从打开文件表中删除条目

#### 打开文件管理
在多个应用程序同时打开同一文件的环境中，实现变得更加复杂：

- **进程级表**：跟踪进程打开的所有文件
- **系统级表**：包含进程无关的信息（文件在磁盘上的位置、访问日期、文件大小）

管理打开文件需要的数据：
- **文件指针**：指向最后读/写位置的指针，对于打开文件的每个进程都是唯一的
- **文件打开计数**：文件被打开的次数，允许在最后一个进程关闭文件时从打开文件表中删除数据
- **文件的磁盘位置**：缓存在内存中以避免每次操作都读取
- **访问权限**：每个进程的访问模式信息

### 8.2.6 文件锁定

**文件锁定 (File Locking)** 由某些操作系统和文件系统提供，用于调解对文件的访问。

#### 锁定类型
- **共享锁 (Shared Lock)**：读者锁，多个进程可以同时持有
- **排他锁 (Exclusive Lock)**：写者锁，只有一个进程可以持有

#### 锁定方式
- **强制性锁定 (Mandatory)**：一旦进程获得排他锁，其他任何访问都被拒绝
- **建议性锁定 (Advisory)**：进程可以查找锁的状态并决定要做什么

### 8.2.7 文件访问方法

#### 顺序访问 (Sequential Access)
- 按顺序处理文件中的记录
- 基于磁带模型的文件
- 操作：read next, write next, reset

#### 直接访问 (Direct Access)
- 可以快速读写记录，不按特定顺序
- 基于磁盘模型的文件
- 操作：read n, write n, position to n
- n = 相对块号

#### 其他访问方法
通常涉及为文件构建索引：
- 要在文件中查找记录，首先搜索索引
- 使用指针直接访问文件并查找所需记录
- 对于大文件，索引文件本身可能变得太大而无法保存在内存中

## 8.3 目录系统

### 8.3.1 目录概述

**目录 (Directory)** 用于组织文件（和目录），可以看作是将文件名转换为其目录条目的符号表。

#### 目录操作
- **搜索文件**：在目录中查找特定文件
- **创建文件**：在目录中添加新的文件条目
- **删除文件**：从目录中删除文件条目
- **列出目录**：显示目录中的所有文件
- **重命名文件**：更改目录中文件的名称
- **遍历文件系统**：系统地访问每个目录和文件

#### 目录组织的评价标准
- **效率**：快速定位文件
- **命名**：方便用户使用
  - 两个用户可以对不同文件使用相同名称
  - 同一文件可以有几个不同的名称
- **分组**：按属性对文件进行逻辑分组（例如，所有Java程序、所有游戏）

### 8.3.2 目录结构类型

#### 单级目录 (Single-Level Directory)
- 所有用户共享一个目录
- **命名问题**：每个文件必须有唯一名称
- **分组问题**：不同用户之间的混淆

#### 二级目录 (Two-Level Directory)
- 为每个用户提供单独的目录——用户文件目录(UFD)
- 系统的主文件目录(MFD)按用户名索引，每个条目指向一个UFD
- 不同用户可以有相同的文件名
- **路径名**：用户名和文件名定义从根到叶子的路径
- **优点**：搜索效率高
- **缺点**：没有分组能力，不同用户之间共享文件困难

#### 树状目录 (Tree-Structured Directories)
- 允许用户创建自己的子目录
- 为不同主题的文件创建目录
- 为不同信息形式的文件创建目录
- 目录或子目录可以包含一组文件或子目录
- 目录只是另一个文件，但以特殊方式处理

**当前目录 (工作目录)**：
- 改变当前目录：`cd /spell/mail/prog`
- 在当前目录中创建或删除文件
- 在当前目录中创建或删除子目录

**路径名类型**：
- **绝对路径名**：从根开始
- **相对路径名**：从当前目录开始

#### 无环图目录 (Acyclic-Graph Directories)
- 树状目录 + 共享子目录或文件
- 同一文件或子目录可能在两个不同的目录中

**实现共享的方法**：
1. **创建链接 (Link)**
   - 实际上是指向另一个文件或目录的指针
   - 链接可以是绝对或相对路径名
   - 被称为间接指针

2. **复制所有共享信息**
   - 在两个共享目录中复制所有信息
   - 使原始文件和副本无法区分
   - 修改文件时难以维护一致性

**潜在问题**：
- 遍历文件系统时可能多次遍历共享结构
- 文件可能有多个绝对名称（别名）
- 删除文件时的悬空指针问题

#### 通用图目录 (General Graph Directory)
- 在现有树状目录结构中添加链接
- **遍历问题**：需要避免搜索任何组件两次，设计不良的算法可能导致无限循环
- **删除问题**：通常使用引用计数，但自引用需要垃圾回收

### 8.3.3 目录实现

#### 线性列表 (Linear List)
使用带有指向数据块指针的文件名线性列表：

**操作过程**：
- **查找文件**：需要线性搜索
- **创建文件**：搜索目录确保没有同名文件存在，然后在目录末尾添加新条目
- **删除文件**：搜索目录找到文件，删除条目，释放分配给文件的空间

**优缺点**：
- 编程简单，但执行耗时
- 搜索代价昂贵

#### 哈希表 (Hash Table)
使用线性列表存储目录条目，使用哈希表根据文件名快速找到目录条目：

**有冲突版本**：
- 每个哈希条目有多个值的列表
- 使用哈希函数将文件名映射到哈希值
- 使用该值索引哈希表，然后搜索列表找到目录条目

**无冲突版本**：
- 每个哈希条目只有单个值
- 哈希函数应该动态改变
- 最快的方法

**优点**：减少目录搜索时间

## 8.4 文件系统实现机制

### 8.4.1 文件系统的数据结构

#### 磁盘上的结构
1. **启动控制块 (Boot Control Block)**
   - UFS：启动块，NTFS：分区启动扇区
   - 用于从该分区启动操作系统

2. **分区控制块 (Partition Control Block)**
   - UFS：超级块，NTFS：主文件表(MFT)
   - 包含块号、块大小、空闲块计数、空闲块指针、空闲FCB计数和FCB指针

3. **目录结构**
   - 用于组织文件
   - UFS：包括文件名和i-node号

4. **文件控制块 (FCB)**
   - 包含文件权限、所有权、大小、数据块位置

#### 内存中的结构
用于文件系统管理和通过缓存提高性能：

1. **内存中的分区表**：包含每个挂载分区的信息
2. **内存中的目录结构**：包含最近访问目录的目录信息
3. **系统级打开文件表**：包含每个打开文件的FCB副本以及其他信息
4. **进程级打开文件表**：包含指向系统级打开文件表中适当条目的指针以及其他信息

### 8.4.2 文件分配方法

#### 连续分配 (Contiguous Allocation)
每个文件占用磁盘上一组连续的块：

**特点**：
- 目录只需要起始位置（块号）和长度（块数）
- 支持顺序访问和直接访问
- 实现简单

**问题**：
- **外部碎片**：浪费空间（动态存储分配问题）
- **文件无法增长**：如何为文件指定初始大小

**改进方案 - 基于扩展区的文件系统**：
- 初始分配一块连续空间
- 如果空间不够，添加一个扩展区
- 扩展区是连续的磁盘块
- 文件由一个或多个扩展区组成

#### 链式分配 (Linked Allocation)
每个文件都是磁盘块的链表，块可以分散在磁盘的任何地方：

**特点**：
- 目录包含指向文件第一个和最后一个块的指针
- 每个磁盘块包含指向下一个块的指针

**优点**：
- 简单，只需要起始地址
- 没有外部碎片
- 容易分配和回收块

**缺点**：
- 没有随机访问
- 指针浪费空间
- 可靠性差

**文件分配表 (FAT)**：
- MS-DOS和OS/2使用的磁盘空间分配
- FAT是重复的
- 支持直接访问
- 被缓存
- 磁盘利用率差

#### 索引分配 (Indexed Allocation)
将所有指针聚集到一个位置：索引块：

**特点**：
- 每个文件都有自己的索引块
- 目录包含索引块的地址
- 索引表包含指向文件各个块的指针

**访问方法**：
- 支持顺序访问和直接访问
- 需要索引块
- LA/1024 = Q（索引表中的位移）+ R（块中的位移）

**大文件的解决方案**：
1. **链式方案**：链接索引表的块
2. **多级索引**：类似于分页
3. **组合方案**：UNIX UFS的实现
   - 12个直接指针（12×4K=48K）
   - 1个单级间接块（4M）
   - 1个双级间接块（4G）
   - 1个三级间接块（4T）

### 8.4.3 空闲空间管理

#### 位向量 (Bit Vector)
空闲空间列表实现为位图或位向量：

**特点**：
- 每个块用1位表示
- 如果块是空闲的，位是1；如果块被分配，位是0
- 块号计算 = (每字位数) × (0值字数) + 第一个1位的偏移

**优缺点**：
- 实现简单
- 高效找到第一个空闲块
- 位图需要额外空间
- 除非整个向量保存在主内存中，否则效率低

#### 链表 (Linked List)
将所有空闲磁盘块链接在一起：

**特点**：
- 不浪费空间
- 遍历列表时效率低

#### 分组 (Grouping)
UNIX中采用的方法：

**特点**：
- 第一个空闲块存储n个空闲块的地址
- 前n-1个块是空闲块
- 第n个块包含另外n个空闲块的地址
- 更容易找到大量空闲块

#### 计数 (Counting)
每个条目是一对（起始地址，连续块数）而不仅仅是地址：

**特点**：
- 总列表更小
- 通常连续分配和释放多个块

## 8.5 文件系统挂载与共享

### 8.5.1 文件系统挂载

**挂载 (Mount)** 是指在访问文件系统之前必须先将其挂载，就像使用文件之前必须先打开一样。

#### 挂载过程
1. 读取超级块（通过设备驱动程序）
2. 验证其一致性
3. 必要时修复（fsck）
4. 在内存挂载表结构中添加条目

#### 不同系统的挂载方式

**Windows系统**：
- 启动时挂载：C:, D:

**UNIX系统**：
- 在目录挂载分区
- 在挂载表中添加条目
- 让挂载表条目的一个字段指向该设备上文件系统的超级块
- 在该目录的i-node的内存副本中设置一个字段，指示在该处挂载了哪个设备

### 8.5.2 虚拟文件系统

**虚拟文件系统 (VFS)** 提供面向对象的文件系统实现方式。

#### VFS的作用
- 如何支持多个文件系统？
- 如何将许多文件系统集成到目录结构中？
- 如何在各种文件系统之间无缝移动？

#### VFS的实现
- API是对VFS接口的，而不是对任何特定类型的文件系统
- VFS允许同一系统调用接口（API）用于不同类型的文件系统
- VFS基于称为vnode的文件表示结构，该结构包含网络范围内唯一文件的数字指示符

#### VFS的层次结构
- **顶层**：文件系统接口（open, read, write, close和文件描述符）
- **中间层**：VFS层，通过定义清洁的VFS接口将文件系统通用操作与其实现分离
- **底层**：各种文件系统实现（Ext3、NFS等）

### 8.5.3 文件共享

#### 多用户共享
为了实现共享和保护，系统必须维护更多文件和目录属性：

1. **所有者 (Owner)**
   - 用户ID标识用户，用户可以更改文件并授予访问权限

2. **组 (Group)**
   - 组ID允许用户加入组，允许组访问权限

#### 远程文件系统
在分布式系统上，文件可以通过网络共享：

**网络文件共享方式**：
- 通过FTP等程序手动共享
- 通过万维网半自动共享
- 使用分布式文件系统(DFS)自动共享

**客户端-服务器模型**：
- 允许计算机从一个或多个远程机器挂载一个或多个文件系统
- 服务器：包含文件的机器
- 客户端：寻求访问文件的机器
- 服务器可以为多个客户端服务，客户端可以使用多个服务器

**认证挑战**：
- 客户端和客户端上的用户识别不安全或复杂
- 可以通过IP地址或其他标识符指定客户端，但这些可能被欺骗

#### 分布式信息系统
需要分布式命名服务(DNS)来管理客户端/服务器系统：
- DNS为整个Internet提供主机名到网络地址的转换
- SUN的NIS集中存储用户名、主机名、打印机信息
- Microsoft的CIPS和Active Directory
- LDAP（轻量级目录访问协议）

#### 故障模式
**本地文件系统故障**：
- 磁盘故障
- 目录结构或元数据损坏
- 磁盘控制器故障
- 电缆故障
- 主机适配器故障

**远程文件系统**：
- 由于网络故障、服务器故障增加新的故障模式
- 从故障中恢复可能涉及每个远程请求状态的状态信息
- 无状态协议（如NFS）在每个请求中包含所有信息，允许轻松恢复但安全性较低

## 8.6 文件系统性能与可靠性

### 8.6.1 效率优化

#### 磁盘分配和目录算法优化

**预分配**：
- 在分区上预分配i-node并将它们分布在分区中(UNIX FS)
- 尝试将文件的数据块保持在文件的i-node块附近以减少寻道时间

**变化的簇大小**：
- 不同的簇大小(BSD UNIX)
- 可以填充的地方使用大簇
- 小文件和文件的最后一个簇使用小簇
- 减少碎片

#### 目录条目中数据类型优化

**最后访问日期**：
- 每当读取文件时，必须写入目录结构中的字段
- 必须将目录条目块读入内存，然后写回磁盘
- 对于频繁访问的文件，这个要求可能是低效的

**指针大小**：
- 指针大小限制文件的长度
  - 16位指针：2^16 (64K)
  - 32位指针：2^32 (4G)
  - 64位指针：2^64
- 长指针占用更多存储空间
- 分配和空闲空间管理方法使用更多磁盘空间

### 8.6.2 性能优化技术

#### 缓存机制

**磁盘控制器缓存**：
- 大多数磁盘控制器包括本地内存以形成板载缓存

**缓冲区缓存**：
- 维护主内存的单独部分作为缓冲区缓存

**页面缓存**：
- 使用页面缓存缓存文件数据
- 使用虚拟内存技术（内存映射文件）将文件数据缓存为页面而不是面向文件系统的块

**统一缓冲区缓存**：
- 用于避免双重缓存，允许虚拟内存系统管理文件系统数据
- 统一缓冲区缓存使用相同的页面缓存来缓存内存映射页面和普通文件系统I/O

#### 读写策略

**同步写入**：
- 写入不被缓冲
- 调用例程必须等待数据到达磁盘驱动器才能处理

**异步写入**：
- 数据存储在缓存中，控制返回到调用例程
- 元数据写入可以是同步的
- 操作系统通常在open()系统调用中包含一个标志，允许进程请求同步执行写入

#### 缓存替换算法

**随机访问**：
- LRU似乎是块或页面替换的合理通用算法

**顺序访问**：
- **Free-behind**：一旦请求下一页，立即从缓冲区中删除页面
- **Read-ahead**：请求页面和几个后续页面被读取和缓存

### 8.6.3 故障恢复

#### 一致性检查
定期运行一致性检查程序：
- 比较目录结构中的数据与磁盘上的数据块，并尝试修复任何不一致
- 可以分配未引用的块
- 如果块引用缺失，可以将其添加到空闲空间列表

#### 备份和恢复
**备份策略**：
- 由于磁盘故障，有时整个文件系统需要从备份中恢复
- 备份到另一个磁盘、磁带或其他存储设备
- 增量备份可以减少备份时间和空间

**恢复程序**：
- 从备份中恢复整个文件系统，然后从日志中恢复

### 8.6.4 日志结构文件系统

**日志结构文件系统 (Log-Structured File System)** 记录对文件系统的每次更新作为日志中的事务。

#### 工作原理
- 所有元数据更改都写入日志
- 每个日志条目包含：
  - 事务号
  - 修改的块列表
  - 修改前后的值
- 日志写入是原子的

#### 优点
- 通过重放日志条目可以快速恢复
- 提供事务语义
- 提高写入性能（将随机写入转换为顺序写入）

## 8.7 文件保护与安全

### 8.7.1 访问控制

文件所有者/创建者应该能够控制：
- **可以做什么**：读取、写入、执行等操作
- **由谁来做**：哪些用户或组可以访问

### 8.7.2 访问类型

- **读取 (Read)**：从文件中读取数据
- **写入 (Write)**：向文件中写入数据
- **执行 (Execute)**：将文件作为程序执行
- **追加 (Append)**：在文件末尾添加数据
- **删除 (Delete)**：删除文件
- **列表 (List)**：列出文件名和属性

其他高级功能（重命名、复制、编辑）可能由系统程序实现。

### 8.7.3 访问控制方法

#### 访问控制列表 (ACL)
最常见的方法：基于用户身份的访问控制：
- 每个文件或目录都有一个ACL
- 指定用户名和每个用户允许的访问类型

#### 其他保护方法
- **密码保护**：为每个文件关联密码
- **加密**：对文件内容进行加密保护

## 8.8 实际文件系统示例

### 8.8.1 Unix文件系统 (UFS)
- 使用i-node存储文件元数据
- 支持硬链接和软链接
- 使用组合分配方案（直接指针+间接指针）

### 8.8.2 Windows文件系统

#### FAT (File Allocation Table)
- 简单的文件分配表
- 适用于小容量存储设备
- FAT32支持更大的文件和分区

#### NTFS (New Technology File System)
- 支持大文件和大分区
- 提供文件压缩和加密
- 支持访问控制列表
- 具有日志功能

### 8.8.3 Linux文件系统

#### ext2/ext3/ext4
- ext2：基本的Linux文件系统
- ext3：添加了日志功能
- ext4：改进性能和容量支持

#### 其他Linux文件系统
- ReiserFS：专为小文件优化
- XFS：高性能文件系统
- Btrfs：现代写时复制文件系统

### 8.8.4 网络文件系统 (NFS)
- 允许通过网络访问远程文件
- 客户端-服务器架构
- 支持透明文件访问
- 提供网络文件共享功能